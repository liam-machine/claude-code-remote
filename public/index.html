<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0d1117">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Claude Code Remote</title>

  <!-- Preconnect to CDN for faster resource loading -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Preload critical CDN assets -->
  <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js">
  <link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js">

  <!-- PWA Manifest (F029) -->
  <link rel="manifest" href="/manifest.json">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192.svg">

  <!-- xterm.js from CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <!-- Loading Screen - Shows immediately while app initializes -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-content">
      <div class="loading-logo">⟩_</div>
      <h1 class="loading-title">Claude Code</h1>
      <div class="loading-spinner"></div>
      <p class="loading-status" id="loadingStatus">Starting up...</p>
      
      <!-- Elapsed time (shows after 3s) -->
      <div class="loading-elapsed" id="loadingElapsed">
        <span class="elapsed-time" id="elapsedTime">0s</span>
        <span class="elapsed-hint" id="elapsedHint"></span>
      </div>
      
      <!-- Retry button (shows after 45s) -->
      <button id="retryBtn" class="loading-retry-btn" style="display: none;">
        Retry Connection
      </button>
    </div>
  </div>

  <div class="app-container" id="appContainer">
    <header class="header">
      <div class="header-left">
        <button class="refresh-btn" id="refreshBtn" title="Hard Refresh App" aria-label="Hard refresh app">↻</button>
        <h1>Claude Code CLI</h1>
      </div>
      <div class="status-indicator">
        <span class="status-dot"></span>
        <span class="status-text">Connecting...</span>
      </div>
    </header>
    <nav class="tabs-container">
      <div class="tabs" id="tabs">
        <!-- Tabs will be dynamically inserted here -->
      </div>
      <button class="new-session-btn" id="newSessionBtn" title="New Session">+</button>
    </nav>
    <main class="terminal-container" id="terminalContainer">
      <!-- Terminal elements will be dynamically created here -->
    </main>
  </div>
  
  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <h2>Refresh App?</h2>
      <p>This will clear all cached data and reload the app. Your terminal sessions will be disconnected.</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="confirmCancel">Cancel</button>
        <button class="modal-btn confirm" id="confirmOk">Refresh</button>
      </div>
    </div>
  </div>
  
  <!-- xterm.js and addons from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script src="/js/keyboard-state-manager.js"></script>
  <script src="/js/resize-coordinator.js"></script>
  <script src="/js/terminal.js"></script>
  <script src="/js/app.js"></script>
  <script src="/js/mobile.js"></script>
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          console.log('[App] Service worker registered:', registration.scope);
          
          // Check for updates periodically
          setInterval(() => {
            registration.update();
          }, 60000); // Check every minute
        })
        .catch((error) => {
          console.error('[App] Service worker registration failed:', error);
        });
    }
    
    // Hard refresh function - clears all caches and reloads
    async function hardRefreshApp() {
      console.log('[App] Starting hard refresh...');
      
      try {
        // 1. Unregister all service workers
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          await Promise.all(registrations.map(r => {
            console.log('[App] Unregistering service worker:', r.scope);
            return r.unregister();
          }));
        }
        
        // 2. Clear all caches
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => {
            console.log('[App] Deleting cache:', name);
            return caches.delete(name);
          }));
        }
        
        // 3. Clear storage (except controlBarVisible preference)
        const controlBarPref = localStorage.getItem('controlBarVisible');
        localStorage.clear();
        sessionStorage.clear();
        if (controlBarPref !== null) {
          localStorage.setItem('controlBarVisible', controlBarPref);
        }
        
        console.log('[App] Cache cleared, reloading...');
        
        // 4. Hard reload (bypass cache)
        window.location.reload(true);
      } catch (error) {
        console.error('[App] Hard refresh failed:', error);
        // Fallback to simple reload
        window.location.reload(true);
      }
    }
    
    // Setup refresh button and modal
    (function() {
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                           window.navigator.standalone === true ||
                           document.referrer.includes('android-app://');
      
      const refreshBtn = document.getElementById('refreshBtn');
      const modal = document.getElementById('confirmModal');
      const confirmOk = document.getElementById('confirmOk');
      const confirmCancel = document.getElementById('confirmCancel');
      
      // Show refresh button in standalone mode OR always (for testing)
      if (refreshBtn) {
        // Always show for now - can be changed to isStandalone only
        refreshBtn.style.display = 'flex';
        
        refreshBtn.addEventListener('click', () => {
          modal.classList.add('visible');
        });
      }
      
      // Modal handlers
      if (confirmOk) {
        confirmOk.addEventListener('click', () => {
          modal.classList.remove('visible');
          hardRefreshApp();
        });
      }
      
      if (confirmCancel) {
        confirmCancel.addEventListener('click', () => {
          modal.classList.remove('visible');
        });
      }
      
      // Close modal on overlay click
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('visible');
          }
        });
      }
    })();
  </script>
</body>
</html>
